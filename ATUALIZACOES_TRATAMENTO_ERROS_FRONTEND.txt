================================================================================
ATUALIZAÃ‡Ã•ES NO BACKEND - TRATAMENTO DE ERROS DE PAGAMENTO
InstruÃ§Ãµes para atualizaÃ§Ã£o do Frontend
================================================================================

DATA: 27 de Dezembro de 2025
OBJETIVO: Melhorar tratamento de erros 400/422 da AppyPay e exibir mensagens amigÃ¡veis ao usuÃ¡rio

================================================================================
1. PROBLEMA IDENTIFICADO
================================================================================

ANTES DA CORREÃ‡ÃƒO:
- AppyPay retornava erro 400 (conta suspensa, validaÃ§Ã£o, etc.)
- Backend retornava HTTP 201 Created com dados invÃ¡lidos:
  * status: "PENDING"
  * paymentId: null
  * referenciaPagamento: null
  * mensagem: "Utilize a referÃªncia null..."
- Cliente ficava com pedido "fantasma" sem poder pagar

DEPOIS DA CORREÃ‡ÃƒO:
- Backend agora retorna HTTP 400/500 com mensagem clara
- Pedido Ã© marcado como FAILED imediatamente
- Estoque liberado automaticamente
- Mensagem limpa extraÃ­da do erro da AppyPay

================================================================================
2. MUDANÃ‡AS NO COMPORTAMENTO DA API
================================================================================

ENDPOINT: POST /api/v1/public/checkout

CENÃRIOS DE ERRO AGORA RETORNADOS:

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ CENÃRIO 1: Erro de ValidaÃ§Ã£o da AppyPay (400/422)                      â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ HTTP Status: 402 Payment Required                                      â”‚
â”‚                                                                         â”‚
â”‚ Campos da resposta:                                                    â”‚
â”‚ - timestamp: Data/hora do erro                                         â”‚
â”‚ - status: 402                                                          â”‚
â”‚ - error: "Payment Error"                                               â”‚
â”‚ - message: Mensagem limpa e legÃ­vel (sem JSON tÃ©cnico)                â”‚
â”‚                                                                         â”‚
â”‚ Exemplo de mensagem:                                                   â”‚
â”‚ "As entradas de pagamento estÃ£o suspensas atÃ© que o processo de       â”‚
â”‚  verificaÃ§Ã£o da conta esteja concluÃ­do."                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ CENÃRIO 2: Erro de Rede/Timeout                                        â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ HTTP Status: 402 Payment Required                                      â”‚
â”‚                                                                         â”‚
â”‚ Mensagem:                                                              â”‚
â”‚ "Erro de comunicaÃ§Ã£o com o gateway de pagamento. Tente novamente em   â”‚
â”‚  alguns minutos."                                                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ CENÃRIO 3: ReferÃªncia nÃ£o gerada (REF)                                 â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ HTTP Status: 402 Payment Required                                      â”‚
â”‚                                                                         â”‚
â”‚ Mensagem:                                                              â”‚
â”‚ "Erro ao gerar referÃªncia de pagamento. Tente novamente."             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

================================================================================
3. EXEMPLOS DE MENSAGENS DE ERRO DA APPYPAY
================================================================================

Estas sÃ£o as mensagens que o backend agora extrai e retorna limpas:

1. "As entradas de pagamento estÃ£o suspensas atÃ© que o processo de 
    verificaÃ§Ã£o da conta esteja concluÃ­do."

2. "Insufficient funds" (Saldo insuficiente)

3. "Invalid payment method" (MÃ©todo de pagamento invÃ¡lido)

4. "Transaction limit exceeded" (Limite de transaÃ§Ã£o excedido)

5. "Account not verified" (Conta nÃ£o verificada)

6. "Service temporarily unavailable" (ServiÃ§o temporariamente indisponÃ­vel)

================================================================================
4. RECOMENDAÃ‡Ã•ES PARA O FRONTEND
================================================================================

4.1. TRATAMENTO DE ERRO NO CHECKOUT
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

IMPLEMENTAR:

1. Capturar erros HTTP 402, 400 e 500 da API
2. Extrair campo "message" da resposta de erro
3. Exibir mensagem AMIGÃVEL ao usuÃ¡rio na tela
4. Registrar detalhes tÃ©cnicos APENAS no console (console.error)
5. Oferecer opÃ§Ãµes de aÃ§Ã£o: "Tentar Novamente" e "Apoio ao Cliente"

IMPORTANTE:
- NÃƒO exibir JSON tÃ©cnico ao usuÃ¡rio
- NÃƒO exibir stack traces na interface
- NÃƒO exibir cÃ³digos HTTP na tela
- Logs tÃ©cnicos devem ir apenas para console.error()

4.2. VALIDAÃ‡ÃƒO DE RESPOSTA DE SUCESSO
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

Mesmo em sucesso (HTTP 201), validar:

1. Para mÃ©todo REFERENCIA:
   - Verificar se campo "referenciaPagamento" nÃ£o Ã© null/vazio
   - Verificar se campo "entidade" nÃ£o Ã© null/vazio
   - Se algum for null: exibir erro e registrar no console

2. Para mÃ©todo GPO:
   - Verificar se campo "paymentId" nÃ£o Ã© null/vazio
   - Verificar campo "status"

3. Em caso de dados invÃ¡lidos:
   - Exibir: "Erro ao processar pagamento. Tente novamente ou contacte o apoio."
   - Registrar detalhes tÃ©cnicos no console.error()

4.3. MENSAGENS PARA O USUÃRIO (UX)
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

PADRÃƒO DE MENSAGEM AMIGÃVEL:

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  [ÃCONE DE ERRO]                      â”‚
â”‚                                       â”‚
â”‚  Erro ao processar o pagamento        â”‚
â”‚                                       â”‚
â”‚  Tente novamente ou contacte          â”‚
â”‚  o apoio ao cliente.                  â”‚
â”‚                                       â”‚
â”‚  [ Tentar Novamente ]                 â”‚
â”‚                                       â”‚
â”‚  Apoio ao Cliente                     â”‚
â”‚  ğŸ“ 925 813 939                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

NOTA: Manter mensagem simples e direta, sem detalhes tÃ©cnicos.

4.4. LOGGING E CONSOLE
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

Registrar no console.error():
- Timestamp do erro
- Status HTTP recebido
- Mensagem completa de erro
- Dados da requisiÃ§Ã£o (mascarando telefone/email)
- ID do pedido (se disponÃ­vel)

NÃƒO registrar:
- Senhas ou tokens
- Dados completos de cartÃ£o (nÃ£o aplicÃ¡vel aqui)
- InformaÃ§Ãµes pessoais sem mascaramento

================================================================================
5. FLUXO COMPLETO RECOMENDADO
================================================================================

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 1. USUÃRIO CLICA EM "FINALIZAR COMPRA"                                 â”‚
â”‚    â†“                                                                    â”‚
â”‚ 2. FRONTEND VALIDA DADOS LOCALMENTE                                    â”‚
â”‚    â†“                                                                    â”‚
â”‚ 3. FRONTEND ENVIA POST /api/v1/public/checkout                         â”‚
â”‚    â†“                                                                    â”‚
â”‚ 4. AGUARDAR RESPOSTA (loading spinner)                                 â”‚
â”‚    â†“                                                                    â”‚
â”‚ 5. RESPOSTA RECEBIDA                                                   â”‚
â”‚    â”‚                                                                    â”‚
â”‚    â”œâ”€ âœ… HTTP 201 Created                                              â”‚
â”‚    â”‚   â”œâ”€ Validar dados da resposta (referencia, paymentId)           â”‚
â”‚    â”‚   â”œâ”€ Se REFERENCIA: Exibir tela com referÃªncia e entidade        â”‚
â”‚    â”‚   â””â”€ Se GPO: Redirecionar ou aguardar confirmaÃ§Ã£o                â”‚
â”‚    â”‚                                                                    â”‚
â”‚    â””â”€ âŒ HTTP 402/400/500                                              â”‚
â”‚        â”œâ”€ Extrair mensagem de erro                                     â”‚
â”‚        â”œâ”€ Classificar tipo de erro                                     â”‚
â”‚        â”œâ”€ Exibir mensagem amigÃ¡vel                                     â”‚
â”‚        â”œâ”€ Oferecer aÃ§Ãµes (tentar novamente, suporte)                  â”‚
â”‚        â””â”€ Registrar erro (analytics)                                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜


7. CHECKLIST DE IMPLEMENTAÃ‡ÃƒO
================================================================================

Frontend:
[ ] Adicionar tratamento de HTTP 402 no checkout
[ ] Validar dados da resposta mesmo em sucesso (HTTP 201)
[ ] Criar componente de erro amigÃ¡vel
[ ] Implementar classificaÃ§Ã£o de tipos de erro
[ ] Adicionar botÃ£o "Tentar Novamente"
[ ] Mascarar dados sensÃ­veis nos logs
[ ] Adicionar analytics para erros de checkout
[ ] Testar todos os cenÃ¡rios de erro
[ ] Atualizar documentaÃ§Ã£o do frontend

Backend (JÃ IMPLEMENTADO):
[âœ“] Detectar erros 400/422 da AppyPay
[âœ“] Extrair mensagem limpa (error_description)
[âœ“] Cancelar reserva em caso de erro
[âœ“] Marcar pedido como FAILED
[âœ“] Validar referÃªncia obrigatÃ³ria para REFERENCIA
[âœ“] Retornar HTTP 402 com mensagem limpa

================================================================================
8. MENSAGENS PARA O USUÃRIO - PADRÃƒO UX
================================================================================

REGRA GERAL:
Todas as mensagens de erro devem seguir o padrÃ£o:

"Erro ao processar o pagamento. Tente novamente ou contacte o apoio ao cliente."

DETALHES TÃ‰CNICOS:
- Devem ser registrados APENAS no console.error()
- NÃƒO devem aparecer na interface do usuÃ¡rio
- Incluir: timestamp, status HTTP, mensagem tÃ©cnica, dados da requisiÃ§Ã£o

INFORMAÃ‡Ã•ES NA TELA:
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  âŒ Erro ao processar o pagamento     â”‚
â”‚                                       â”‚
â”‚  Tente novamente ou contacte          â”‚
â”‚  o apoio ao cliente.                  â”‚
â”‚                                       â”‚
â”‚  [ Tentar Novamente ]                 â”‚
â”‚                                       â”‚
â”‚  Apoio ao Cliente:                    â”‚
â”‚  ğŸ“ 925 813 939                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

NOTA: Manter mensagem simples, amigÃ¡vel e sem jargÃ£o tÃ©cnico.

================================================================================
9. INFORMAÃ‡Ã•ES TÃ‰CNICAS ADICIONAIS
================================================================================

Arquivos Backend Modificados:
- AppyPayProvider.java
  â””â”€ MÃ©todo adicionado: extrairMensagemErro(String errorBody)
  â””â”€ Modificado: onStatus error handler (linha 122-133)

- PedidoService.java
  â””â”€ Modificado: bloco catch (linha 257-332)
  â””â”€ LÃ³gica simplificada: apenas repassa mensagem limpa

Commit:
- Hash: b00f948
- Mensagem: "feat: melhorar extraÃ§Ã£o de mensagens de erro da AppyPay - 
            exibir error_description limpo ao usuÃ¡rio"

Status HTTP Retornados:
- 201: Sucesso (pedido criado)
- 400: Erro de validaÃ§Ã£o (dados invÃ¡lidos)
- 402: Erro de pagamento (Payment Required)
- 500: Erro interno do servidor

================================================================================
10. SUPORTE E CONTATO
================================================================================

Em caso de dÃºvidas sobre a implementaÃ§Ã£o:
- Verificar logs da API em produÃ§Ã£o
- Consultar Swagger: https://api.arenaticket.ao/swagger-ui.html
- Testar endpoint: POST /api/v1/public/checkout

Telefone de suporte ao cliente:
- +244 925 813 939

================================================================================
FIM DO DOCUMENTO
================================================================================
